#!/usr/bin/env bash

REAL_SANDBOX="$HOME/.local/share/claude-code-sandbox"
mkdir -p "$REAL_SANDBOX"

LOCK_FILE="$REAL_SANDBOX/.refcount.lock"
REFCOUNT_FILE="$REAL_SANDBOX/.refcount"
exec {LOCK_FD}>"$LOCK_FILE"

with_lock() {
    flock "$LOCK_FD"
    "$@"
    flock -u "$LOCK_FD"
}

increment_refcount() {
    local count
    count=$(cat "$REFCOUNT_FILE" 2>/dev/null || echo 0)
    echo $((count + 1)) >"$REFCOUNT_FILE"
}

decrement_refcount() {
    local count
    count=$(cat "$REFCOUNT_FILE" 2>/dev/null || echo 1)
    echo $((count - 1)) >"$REFCOUNT_FILE"
    echo $((count - 1))
}

with_lock increment_refcount

ARGS=(--dev-bind / /)
ARGS+=(--bind "$REAL_SANDBOX" "$HOME")

BIND_TARGETS=()

add_bind() {
    local src="$1"
    local dst="$2"
    ARGS+=(--bind "$src" "$dst")
    BIND_TARGETS+=("$REAL_SANDBOX${dst#"$HOME"}")
}

shopt -s dotglob
for item in "$HOME"/*; do
    [[ -e "$item" ]] || continue
    base=$(basename "$item")

    if [[ "$base" == ".local" ]]; then
        ARGS+=(--dir "$HOME/.local" --dir "$HOME/.local/share")
        for sub in "$HOME/.local/share"/*; do
            [[ "$(realpath "$sub")" == "$(realpath "$REAL_SANDBOX")" ]] && continue
            add_bind "$sub" "$sub"
        done
        for sub in "$HOME/.local"/*; do
            [[ "$(basename "$sub")" == "share" ]] && continue
            add_bind "$sub" "$sub"
        done
        continue
    fi

    add_bind "$item" "$item"
done

cleanup() {
    local remaining
    remaining=$(with_lock decrement_refcount)
    if [[ "$remaining" -le 0 ]]; then
        rm -rf "${BIND_TARGETS[@]}"
        rmdir "$REAL_SANDBOX"/.local/share 2>/dev/null
        rmdir "$REAL_SANDBOX"/.local 2>/dev/null
        rm -f "$LOCK_FILE" "$REFCOUNT_FILE"
    fi
}
trap cleanup EXIT

bwrap "${ARGS[@]}" --die-with-parent --setenv HOME "$HOME" /opt/bin/claude "$@"
